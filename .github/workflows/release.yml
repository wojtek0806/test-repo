name: GitHub Release

on:
  push

jobs:
  create_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get the version name from the tags
        run: echo "RELEASE_VERSION=${GITHUB_REF/refs\/tags\//}" >> $GITHUB_ENV

      - name: Build Collection
        uses: artis3n/ansible_galaxy_collection@v2
        with:
          collection_dir: 'ansible_collections/wojtek0806/f5os'
          api_key: '${{ secrets.GALAXY_API_KEY }}'
          publish: false

      - name: Create GitHub Release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          artifacts: 'ansible_collections/wojtek0806/f5os/wojtek0806-f5os-${{ github.ref }}.tar.gz'
          name: 'Release ${{ env.RELEASE_VERSION }}'
          omitBody: true
          token: '${{ secrets.TEST_TOKEN }}'

      - name: Publish Collection
        uses: artis3n/ansible_galaxy_collection@v2
        with:
          collection_dir: 'ansible_collections/wojtek0806/f5os'
          api_key: '${{ secrets.GALAXY_API_KEY }}'
          build: false